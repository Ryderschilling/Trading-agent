<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Backtest • Trading Agent</title>

    <link rel="stylesheet" href="/styles-v4.css" />
    <script src="/ui.js" defer></script>

    <!-- UI-only, scoped to backtest page (strong overrides to beat styles-v4.css) -->
    <style>
      /* ===== Layout symmetry ===== */
      .page-backtest .bt-config-layout{
        display:grid !important;
        grid-template-columns: 1fr 1fr !important;
        gap: 18px !important;
        align-items: stretch !important;
      }

      .page-backtest .bt-config-left,
      .page-backtest .bt-config-right{
        display:flex !important;
        flex-direction:column !important;
        min-width: 0 !important;
      }

      /* Make both sides start at the same visual level */
      .page-backtest .bt-config-left .bt-config-extras,
      .page-backtest .bt-config-right{
        padding-top: 0 !important;
        margin-top: 0 !important;
      }

      /* Left “Tickers” area should fill its half (no weird vertical gaps) */
      .page-backtest .bt-config-left .bt-config-extras{
        height: 100% !important;
        display:flex !important;
        flex-direction:column !important;
        justify-content:flex-start !important;
      }

      /* Right form grid spacing */
      .page-backtest .bt-config-grid{
        margin-top: 10px !important;
      }

      /* ===== Hide the original select but keep it for JS ===== */
      .page-backtest #tickersSelect{
        position:absolute !important;
        left:-9999px !important;
        width:1px !important;
        height:1px !important;
        overflow:hidden !important;
        opacity:0 !important;
        pointer-events:none !important;
      }

      /* ===== Chips UI ===== */
      .page-backtest .bt-tickerChips{
        display:flex !important;
        flex-wrap:wrap !important;
        gap: 10px !important;
        align-content:flex-start !important;
        padding-top: 6px !important;

        /* auto-size via CSS vars set by JS */
        --chipFont: 14px;
        --chipPadY: 10px;
        --chipPadX: 12px;
        --chipRadius: 999px;
      }

      .page-backtest .bt-chip{
        display:inline-flex !important;
        align-items:center !important;
        justify-content:center !important;

        font-size: var(--chipFont) !important;
        font-weight: 800 !important;
        letter-spacing: 0.02em !important;
        padding: var(--chipPadY) var(--chipPadX) !important;
        border-radius: var(--chipRadius) !important;

        border: 1px solid rgba(255,255,255,0.10) !important;
        background: rgba(255,255,255,0.06) !important;
        color: var(--text) !important;

        cursor:pointer !important;
        user-select:none !important;
        transition: transform .12s ease, background .12s ease, border-color .12s ease !important;
      }

      .page-backtest .bt-chip:hover{
        transform: translateY(-1px) !important;
        background: rgba(255,255,255,0.08) !important;
        border-color: rgba(255,255,255,0.14) !important;
      }

      .page-backtest .bt-chip.is-on{
        background: rgba(93,169,255,0.16) !important;
        border-color: rgba(93,169,255,0.26) !important;
      }

      .page-backtest .bt-tickerActions{
        margin-top: 12px !important;
        display:flex !important;
        gap: 10px !important;
        flex-wrap:wrap !important;
      }

      /* ===== Idle/meta: remove “boxed block” look entirely ===== */
      .page-backtest .bt-statusRow{
        display:flex !important;
        align-items:center !important;
        justify-content:flex-start !important;
        gap: 12px !important;

        margin-top: 12px !important;
        padding: 0 !important;

        border: 0 !important;
        background: transparent !important;
        box-shadow: none !important;
        border-radius: 0 !important;
      }

      /* Force-pill only (no surrounding container styling) */
      .page-backtest #btStatusPill{
        margin: 0 !important;
      }

      .page-backtest #runMeta{
        flex: 1 !important;
        min-width: 0 !important;
        white-space: nowrap !important;
        overflow: hidden !important;
        text-overflow: ellipsis !important;
      }

      /* Keep run button from visually “creating” a lower block */
      .page-backtest .bt-runCell{
        display:flex !important;
        flex-direction:column !important;
        justify-content:flex-end !important;
      }

      @media (max-width: 980px){
        .page-backtest .bt-config-layout{ grid-template-columns: 1fr !important; }
      }

      /* =========================
   REMOVE THIN GREY DIVIDER
========================= */

/* Kill any top border that may be drawing the slim line */
.page-backtest .bt-config-left .bt-config-extras,
.page-backtest .bt-config-left .bt-tickersBlock {
  border-top: 0 !important;
  box-shadow: none !important;
}

/* In case it's a pseudo-element */
.page-backtest .bt-config-left .bt-config-extras::before,
.page-backtest .bt-config-left .bt-tickersBlock::before {
  display: none !important;
  content: none !important;
}


/* =========================
   ADD EVEN BOTTOM SPACING
========================= */

/* Add bottom padding equal to top padding */
.page-backtest .bt-config-left .bt-config-extras {
  padding-bottom: 16px !important;
}

/* Ensure space between chips and bottom of box */
.page-backtest .bt-tickerActions {
  margin-bottom: 4px !important;
}
    </style>
  </head>

  <body>
    <div class="bg-wash"></div>

    <header class="topbar">
      <div class="topbar-left">
        <div class="brand">
          <img src="/logo.PNG" class="brand-logo" alt="Logo" />
          <div class="brand-text">Trading Agent</div>
        </div>

        <nav class="tabs">
          <a class="tab" href="/">Workspace</a>
          <a class="tab" href="/outcomes">Outcomes</a>
          <a class="tab" href="/watch">Watch</a>
          <a class="tab" href="/rules">Rules</a>
          <a class="tab active" href="/backtest">Backtest</a>
        </nav>
      </div>

      <div class="topbar-right">
        <div class="status">
          <div class="status-dot" id="socketDot"></div>
          <div class="status-text">Realtime</div>
        </div>
      </div>
    </header>

    <main class="shell page-backtest">
      <section class="stack">

        <!-- BACKTEST CONFIGURATION -->
        <section class="card bt-card bt-config">
          <div class="card-head bt-card-head">
            <div>
              <div class="card-title">Backtest Configuration</div>
            </div>

            <div class="card-actions bt-config-actions">
              <button class="btn" id="refreshBtn">Reset</button>
            </div>
          </div>

          <div class="bt-config-body">
            <div class="bt-config-layout">

              <!-- LEFT: Tickers (chips) -->
              <div class="bt-config-left">
                <div class="bt-config-extras">
                  <div class="bt-tickersBlock">
                    <div class="bt-label">Tickers</div>

                    <!-- Keep select for JS hooks (hidden via CSS) -->
                    <select id="tickersSelect" class="input bt-input" multiple></select>

                    <!-- Chips UI -->
                    <div class="bt-tickerChips" id="btTickerChips" aria-label="Tickers"></div>

                    <div class="bt-tickerActions">
                      <button class="btn" type="button" id="presetMag7Btn">Select MAG7 + Indexes</button>
                      <button class="btn" type="button" id="presetClearBtn">Clear</button>
                    </div>
                  </div>
                </div>
              </div>

              <!-- RIGHT: Inputs + status -->
              <div class="bt-config-right">
                <div class="bt-config-grid">
                  <label class="small bt-field">
                    <span class="bt-label">Strategy Select</span>
                    <select id="strategySelect" class="input bt-input">
                      <option value="active">Active strategy</option>
                    </select>
                  </label>

                  <label class="small bt-field">
                    <span class="bt-label">Timeframe</span>
                    <select id="timeframeSelect" class="input bt-input">
                      <option value="1m">1m</option>
                      <option value="2m">2m</option>
                      <option value="5m">5m</option>
                      <option value="15m">15m</option>
                      <option value="30m">30m</option>
                      <option value="1h">1h</option>
                      <option value="4h">4h</option>
                      <option value="1d">1d</option>
                      <option value="1w">1w</option>
                    </select>
                  </label>

                  <label class="small bt-field">
                    <span class="bt-label">Start Date</span>
                    <input id="startDate" class="input bt-input" type="date" />
                  </label>

                  <label class="small bt-field">
                    <span class="bt-label">End Date</span>
                    <input id="endDate" class="input bt-input" type="date" />
                  </label>

                  <label class="small bt-field">
                    <span class="bt-label">Initial Capital</span>
                    <input id="startEquity" class="input bt-input" placeholder="10000" />
                  </label>

                  <div class="bt-field bt-runCell">
                    <span class="bt-label" style="opacity:0; user-select:none;">Run</span>
                    <button class="btn primary bt-runBtn" id="runBtn">Run Backtest</button>
                  </div>
                </div>

                <!-- Inline status/meta (no box) -->
                <div class="bt-statusRow">
                  <span id="btStatusPill" class="pill pill-idle">Idle</span>
                </div>
              </div>

            </div>
          </div>
        </section>

        <!-- SUMMARY + TRADES -->
        <div class="bt-lowerGrid">
          <section class="card bt-card bt-summary">
            <div class="card-head bt-card-head">
              <div>
                <div class="card-title">Performance Summary</div>
              </div>    

              <!-- keep for JS, hide -->
              <div class="card-actions">
                <select id="sortSelect" class="input bt-input bt-sort" style="display:none">
                  <option value="entryTs_desc">Newest</option>
                  <option value="entryTs_asc">Oldest</option>
                  <option value="r_desc">R (high → low)</option>
                  <option value="r_asc">R (low → high)</option>
                </select>
              </div>
            </div>

            <div class="bt-summary-body">
              <div id="metricsGrid" class="metricsGrid bt-metrics"></div>
              <div class="bt-chartCard">
                <canvas id="equityCanvas"></canvas>
              </div>
            </div>
          </section>

          <section class="card bt-card bt-trades">
            <div class="card-head bt-card-head">
              <div>
                <div class="card-title">Trade Log</div>
              </div>
            </div>

            <div class="bt-tradesWrap">
              <table class="table bt-table">
                <thead>
                  <tr>
                    <th>Ticker</th>
                    <th>Dir</th>
                    <th>Level</th>
                    <th>Entry</th>
                    <th>Stop</th>
                    <th>Target</th>
                    <th>Exit</th>
                    <th>Reason</th>
                    <th>R</th>
                    <th>Bars</th>
                  </tr>
                </thead>
                <tbody id="tradesBody"></tbody>
              </table>
            </div>
          </section>
        </div>

        <!-- TRADE DISTRIBUTION (standalone card under Summary + Trade Log) -->
<section class="card bt-card bt-histCard" style="margin-top: 16px;">
  <div class="card-head bt-card-head">
    <div>
      <div class="card-title">Trade Distribution</div>
      <div class="card-hint">Histogram of R-multiples (per-trade)</div>
    </div>
  </div>

  <div class="bt-histBody">
    <canvas id="distCanvas"></canvas>
    <div id="distMeta" class="small"></div>
  </div>
</section>

      </section>
    </main>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/backtest.js?v=1"></script>

    <!-- UI-only glue: chips synced to #tickersSelect -->
    <script>
      (function () {
        const select = document.getElementById("tickersSelect");
        const chips = document.getElementById("btTickerChips");
        if (!select || !chips) return;

        function computeSizing(n) {
          if (n <= 8)   return { font: 16, py: 11, px: 14 };
          if (n <= 14)  return { font: 14, py: 10, px: 12 };
          if (n <= 20)  return { font: 12, py: 9,  px: 11 };
          return        { font: 11, py: 8,  px: 10 };
        }

        function render() {
          const opts = Array.from(select.options);
          const n = Math.max(opts.length, 1);

          const s = computeSizing(n);
          chips.style.setProperty("--chipFont", s.font + "px");
          chips.style.setProperty("--chipPadY", s.py + "px");
          chips.style.setProperty("--chipPadX", s.px + "px");

          chips.innerHTML = "";
          for (const opt of opts) {
            const btn = document.createElement("button");
            btn.type = "button";
            btn.className = "bt-chip" + (opt.selected ? " is-on" : "");
            btn.textContent = (opt.textContent || opt.value || "").trim();

            btn.addEventListener("click", () => {
              opt.selected = !opt.selected;
              select.dispatchEvent(new Event("change", { bubbles: true }));
              render();
            });

            chips.appendChild(btn);
          }
        }

        const mo = new MutationObserver(() => render());
        mo.observe(select, { childList: true, subtree: true, attributes: true });

        select.addEventListener("change", render);
        render();
      })();
    </script>
  </body>
</html>